<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Rise of the GCC Mall</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
:root {
  --gold:#F0A500; --dark:#080C14;
  --UAE:#2ECC71; --KSA:#E74C3C; --KWT:#3498DB; --QAT:#E67E22; --BHR:#9B59B6; --OMN:#1ABC9C;
  --ph:#C0392B; --bh:72px; --tlh:62px;
}
html,body{ width:100%;height:100%;background:var(--dark);overflow:hidden;font-family:'Rajdhani',sans-serif; }

#map{ position:fixed;top:var(--bh);bottom:var(--tlh);left:0;right:0;background:var(--dark);filter:brightness(0.82) contrast(1.12); }
.leaflet-control-zoom,.leaflet-control-attribution{ display:none !important; }
.leaflet-popup-content-wrapper{ display:none; }

/* ‚îÄ‚îÄ PHASE BAR ‚îÄ‚îÄ */
#phase-bar{
  position:fixed;top:0;left:0;right:0;height:var(--bh);z-index:800;
  display:flex;align-items:stretch;
  background:rgba(5,8,15,0.98);backdrop-filter:blur(20px);
  border-bottom:2px solid var(--ph);transition:border-color 0.7s;overflow:hidden;
}
#phase-bar::before{ content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--ph);transition:background 0.7s; }
.pb-block{ display:flex;align-items:center;padding:0 24px 0 30px;flex-shrink:0; }
.pb-tag{ display:flex;flex-direction:column;gap:2px; }
.pb-num{ font-size:9px;letter-spacing:5px;font-weight:700;text-transform:uppercase;color:var(--ph);transition:color 0.7s;line-height:1; }
.pb-name{ font-family:'Cinzel',serif;font-size:18px;font-weight:900;color:#fff;line-height:1.1;white-space:nowrap; }
.pb-name em{ font-style:normal;color:var(--ph);transition:color 0.7s; }
.pb-period{ font-size:9px;letter-spacing:3px;color:rgba(255,255,255,0.28);text-transform:uppercase;margin-top:1px;white-space:nowrap; }
.pb-vr{ width:1px;align-self:stretch;margin:14px 0;background:rgba(255,255,255,0.07);flex-shrink:0; }
.pb-q-block{ padding:0 20px;display:flex;flex-direction:column;justify-content:center; }
.pb-q-eye{ font-size:8px;letter-spacing:4px;color:rgba(240,165,0,0.45);text-transform:uppercase;margin-bottom:3px; }
.pb-q-txt{ font-size:13px;font-weight:500;color:rgba(255,255,255,0.72);font-style:italic;white-space:nowrap; }
.pb-pills{ display:flex;align-items:center;gap:7px;padding:0 16px;overflow:hidden; }
.pb-pill{ font-size:9px;letter-spacing:2px;font-weight:700;text-transform:uppercase;padding:4px 11px;white-space:nowrap;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); }
.pb-count-block{ margin-left:auto;padding:0 26px;display:flex;flex-direction:column;align-items:flex-end;justify-content:center;flex-shrink:0; }
.pb-count-n{ font-family:'Cinzel',serif;font-size:30px;font-weight:900;color:var(--ph);line-height:1;transition:color 0.7s; }
.pb-count-l{ font-size:8px;letter-spacing:3px;color:rgba(255,255,255,0.28);text-transform:uppercase; }

/* ‚îÄ‚îÄ PHOTO CARD (left) ‚îÄ‚îÄ */
#photo-card{
  position:fixed;top:calc(var(--bh) + 20px);left:24px;width:218px;z-index:600;
  background:rgba(5,8,15,0.96);backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,0.07);overflow:hidden;
  transform:translateX(-115%);opacity:0;
  transition:transform 0.65s cubic-bezier(0.34,1.2,0.64,1),opacity 0.4s;
}
#photo-card.show{ transform:translateX(0);opacity:1; }
.ph-bar{ height:3px;width:100%;transition:background 0.5s; }
.ph-slot{
  width:100%;height:170px;position:relative;overflow:hidden;
  border-bottom:1px solid rgba(255,255,255,0.05);background:#0b1018;
}
.ph-slot img{
  width:100%;height:100%;object-fit:cover;
  opacity:0;transition:opacity 0.5s ease,transform 0.6s ease;display:block;
}
.ph-slot img.loaded{ opacity:1; }
.ph-slot img:hover{ transform:scale(1.04); }
.ph-placeholder{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  pointer-events:none;transition:opacity 0.4s;
}
.ph-placeholder.hidden{ opacity:0; }
.ph-icon{ font-size:26px;opacity:0.18; }
.ph-lbl-text{ font-size:8px;letter-spacing:3px;font-weight:600;text-transform:uppercase;color:rgba(255,255,255,0.15);text-align:center;line-height:1.6; }
.ph-tag-strip{
  position:absolute;bottom:0;left:0;right:0;
  padding:5px 10px;
  background:linear-gradient(0deg,rgba(0,0,0,0.7),transparent);
  font-size:8px;letter-spacing:2px;font-weight:700;text-transform:uppercase;
  color:rgba(255,255,255,0.4);
}
.ph-caption{ padding:11px 14px 13px; }
.ph-cap-name{ font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:rgba(255,255,255,0.75);line-height:1.3; }
.ph-cap-city{ font-size:9px;letter-spacing:3px;color:rgba(255,255,255,0.24);text-transform:uppercase;margin-top:3px; }

/* ‚îÄ‚îÄ INFO CARD (right) ‚îÄ‚îÄ */
#info-card{
  position:fixed;top:calc(var(--bh) + 20px);right:24px;width:300px;z-index:600;
  background:rgba(5,8,15,0.96);backdrop-filter:blur(24px);
  border:1px solid rgba(255,255,255,0.07);overflow:hidden;
  transform:translateX(115%);opacity:0;
  transition:transform 0.65s cubic-bezier(0.34,1.2,0.64,1),opacity 0.4s;
}
#info-card.show{ transform:translateX(0);opacity:1; }
.ic-bar{ height:3px;width:100%;transition:background 0.5s; }
.ic-body{ padding:20px 22px 22px; }
.ic-top{ display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:2px; }
.ic-year{ font-family:'Cinzel',serif;font-size:54px;font-weight:900;color:var(--gold);line-height:1; }
.ic-type{ font-size:9px;letter-spacing:2.5px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.22);text-align:right;padding-bottom:8px;max-width:110px;line-height:1.5; }
.ic-name{ font-family:'Cinzel',serif;font-size:20px;font-weight:900;color:#fff;line-height:1.2;margin-top:5px; }
.ic-loc{ display:flex;align-items:center;gap:7px;margin-top:6px;font-size:11px;letter-spacing:3px;color:rgba(255,255,255,0.32);text-transform:uppercase; }
.ic-flag{ font-size:18px; }
.ic-sep{ height:1px;margin:16px 0;opacity:0.25; }
.ic-role{ font-size:17px;font-weight:600;color:rgba(255,255,255,0.88);line-height:1.5; }
.ic-gap{ height:10px; }
.ic-logic{ font-size:13px;font-weight:400;font-style:italic;color:rgba(255,255,255,0.45);line-height:1.6; }
.ic-badge{ display:inline-flex;align-items:center;gap:6px;margin-top:16px;padding:5px 14px;font-size:10px;letter-spacing:3px;font-weight:700;text-transform:uppercase;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); }

/* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
#timeline{ position:fixed;bottom:0;left:0;right:0;height:var(--tlh);z-index:800;background:rgba(5,8,15,0.98);backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;justify-content:center;padding:0 26px;opacity:0;transition:opacity 0.7s; }
#timeline.show{ opacity:1; }
.tl-track{ position:relative;height:4px;background:rgba(255,255,255,0.05);border-radius:2px;margin-bottom:8px;overflow:visible; }
.tl-seg{ position:absolute;top:0;bottom:0;border-radius:2px;opacity:0.3; }
#tl-fill{ position:absolute;top:0;left:0;bottom:0;border-radius:2px;background:var(--ph);width:0%;transition:width 0.8s ease,background 0.7s;box-shadow:0 0 8px var(--ph); }
#tl-cursor{ position:absolute;top:50%;transform:translate(-50%,-50%);width:13px;height:13px;border-radius:50%;background:#fff;border:2px solid var(--ph);box-shadow:0 0 10px var(--ph);transition:left 0.8s ease,border-color 0.7s,box-shadow 0.7s;z-index:2; }
.tl-dot{ position:absolute;top:50%;transform:translate(-50%,-50%);width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,0.2);z-index:1;transition:background 0.3s; }
.tl-dot.lit{ background:var(--ph);opacity:0.9; }
.tl-labels{ display:flex;pointer-events:none; }
.tl-lbl{ font-size:8px;letter-spacing:2px;font-weight:700;text-transform:uppercase;flex:1;text-align:center;opacity:0.35;transition:opacity 0.4s,color 0.4s; }
.tl-lbl.active{ opacity:1; }
#tl-badge{ position:fixed;bottom:calc(var(--tlh) + 5px);font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:#fff;background:var(--ph);padding:3px 10px;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);transform:translateX(-50%);z-index:801;opacity:0;pointer-events:none;transition:opacity 0.5s,left 0.8s ease,background 0.7s; }
#tl-badge.show{ opacity:1; }

/* ‚îÄ‚îÄ INTRO ‚îÄ‚îÄ */
#intro{ position:fixed;inset:0;z-index:1000;background:var(--dark);display:flex;align-items:center;justify-content:center;transition:opacity 1.2s ease; }
#intro.gone{ opacity:0;pointer-events:none; }
.i-scan{ position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(240,165,0,0.013) 2px,rgba(240,165,0,0.013) 4px); }
.i-ring{ position:absolute;width:660px;height:660px;border:1px solid rgba(240,165,0,0.07);border-radius:50%;animation:spin 38s linear infinite; }
.i-ring::before{ content:'';position:absolute;inset:55px;border:1px solid rgba(240,165,0,0.04);border-radius:50%; }
.i-ring::after{ content:'';position:absolute;inset:130px;border:1px solid rgba(240,165,0,0.024);border-radius:50%; }
@keyframes spin{ to{ transform:rotate(360deg); } }
.i-body{ position:relative;text-align:center; }
.i-eye{ font-size:10px;letter-spacing:7px;font-weight:600;text-transform:uppercase;color:var(--gold);margin-bottom:22px;opacity:0;animation:rise 0.8s 0.3s forwards; }
.i-ttl{ font-family:'Cinzel',serif;font-size:clamp(44px,6.5vw,88px);font-weight:900;color:#fff;line-height:1;letter-spacing:-1px;opacity:0;animation:rise 0.8s 0.6s forwards; }
.i-ttl span{ color:var(--gold); }
.i-sub{ font-size:17px;font-weight:300;color:rgba(255,255,255,0.38);letter-spacing:4px;margin-top:16px;opacity:0;animation:rise 0.8s 0.9s forwards; }
.i-ln{ width:80px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:28px auto;opacity:0;animation:rise 0.8s 1.1s forwards; }
.i-st{ display:flex;gap:46px;justify-content:center;opacity:0;animation:rise 0.8s 1.3s forwards; }
.i-s{ text-align:center; }
.i-sn{ font-family:'Cinzel',serif;font-size:34px;color:var(--gold);font-weight:700; }
.i-sl{ font-size:10px;letter-spacing:3px;color:rgba(255,255,255,0.28);text-transform:uppercase; }
@keyframes rise{ from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ OUTRO ‚îÄ‚îÄ */
#outro{ position:fixed;inset:0;z-index:900;background:rgba(5,8,15,0);display:flex;align-items:center;justify-content:center;pointer-events:none;transition:background 1.5s; }
#outro.show{ background:rgba(5,8,15,0.93);pointer-events:all; }
#oc{ text-align:center;opacity:0;transform:translateY(28px);transition:opacity 1s 0.5s,transform 1s 0.5s; }
#outro.show #oc{ opacity:1;transform:translateY(0); }
.o-eye{ font-size:9px;letter-spacing:7px;color:var(--gold);text-transform:uppercase;margin-bottom:14px; }
.o-ttl{ font-family:'Cinzel',serif;font-size:clamp(28px,4.5vw,56px);font-weight:900;color:#fff; }
.o-ttl span{ color:var(--gold); }
.o-credit{ font-size:11px;letter-spacing:4px;color:rgba(255,255,255,0.35);text-transform:uppercase;margin-top:10px;margin-bottom:2px; }
.o-sep{ width:100px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:28px auto; }
.o-stats{ display:flex;gap:50px;justify-content:center;flex-wrap:wrap; }
.o-stat{ text-align:center; }
.o-sn{ font-family:'Cinzel',serif;font-size:44px;font-weight:900;color:var(--gold); }
.o-sl{ font-size:10px;letter-spacing:4px;color:rgba(255,255,255,0.36);text-transform:uppercase;margin-top:4px; }
.o-phases{ display:flex;gap:10px;justify-content:center;margin-top:26px;flex-wrap:wrap; }
.o-pill{ padding:5px 14px;font-size:9px;letter-spacing:2px;font-weight:700;text-transform:uppercase;clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); }
#o-replay{ margin-top:28px;padding:14px 44px;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:var(--dark);background:var(--gold);border:none;cursor:pointer;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);transition:all 0.3s; }
#o-replay:hover{ background:#FFD166;transform:scale(1.04); }

/* ‚îÄ‚îÄ CREDIT WATERMARK ‚îÄ‚îÄ */
#credit{
  position:fixed;bottom:calc(var(--tlh) + 8px);right:16px;
  z-index:700;
  font-family:'Rajdhani',sans-serif;
  font-size:9px;letter-spacing:3px;font-weight:600;text-transform:uppercase;
  color:rgba(255,255,255,0.22);
  pointer-events:none;
}

/* ‚îÄ‚îÄ PINS ‚îÄ‚îÄ */
@keyframes pinDrop{ 0%{transform:translateY(-60px) scale(0.4);opacity:0} 60%{transform:translateY(6px) scale(1.1);opacity:1} 80%{transform:translateY(-3px) scale(0.96)} 100%{transform:translateY(0) scale(1);opacity:1} }
@keyframes pinPulse{ 0%{transform:translate(-50%,-50%) scale(1);opacity:0.8} 70%{transform:translate(-50%,-50%) scale(3.2);opacity:0} 100%{transform:translate(-50%,-50%) scale(3.2);opacity:0} }
.mall-pin{ width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.5);position:relative;animation:pinDrop 0.7s cubic-bezier(0.34,1.56,0.64,1) forwards; }
.mall-pin::after{ content:'';position:absolute;top:50%;left:50%;width:14px;height:14px;border-radius:50%;background:inherit;animation:pinPulse 1.6s 0.7s ease-out forwards; }
.leaflet-marker-icon{ background:none !important;border:none !important; }
</style>
</head>
<body>
<div id="map"></div>
<div id="credit">Prepared by Damien Nouvel 2026</div>

<!-- PHASE BAR -->
<div id="phase-bar">
  <div class="pb-block">
    <div class="pb-tag">
      <div class="pb-num"    id="pb-num">Phase 1</div>
      <div class="pb-name"   id="pb-name"><em>Foundations</em></div>
      <div class="pb-period" id="pb-period">1978 ‚Äì 1989</div>
    </div>
  </div>
  <div class="pb-vr"></div>
  <div class="pb-q-block">
    <div class="pb-q-eye">Strategic Question</div>
    <div class="pb-q-txt" id="pb-q">How do we modernize shopping?</div>
  </div>
  <div class="pb-vr"></div>
  <div class="pb-pills" id="pb-pills"></div>
  <div class="pb-count-block">
    <div class="pb-count-n" id="pb-n">0</div>
    <div class="pb-count-l">Major malls</div>
  </div>
</div>

<!-- PHOTO CARD -->
<div id="photo-card">
  <div class="ph-bar" id="ph-bar"></div>
  <div class="ph-slot">
    <div class="ph-placeholder" id="ph-ext-ph"><div class="ph-icon">üèõÔ∏è</div><div class="ph-lbl-text">Exterior Photo</div></div>
    <img id="ph-ext-img" src="" alt="" />
    <div class="ph-tag-strip"></div>
  </div>
  <div class="ph-slot">
    <div class="ph-placeholder" id="ph-int-ph"><div class="ph-icon">üõçÔ∏è</div><div class="ph-lbl-text">Interior Photo</div></div>
    <img id="ph-int-img" src="" alt="" />
    <div class="ph-tag-strip"></div>
  </div>
  <div class="ph-caption">
    <div class="ph-cap-name" id="ph-name"></div>
    <div class="ph-cap-city" id="ph-city"></div>
  </div>
</div>

<!-- INFO CARD -->
<div id="info-card">
  <div class="ic-bar"  id="ic-bar"></div>
  <div class="ic-body">
    <div class="ic-top">
      <div class="ic-year" id="ic-year"></div>
      <div class="ic-type" id="ic-type"></div>
    </div>
    <div class="ic-name"  id="ic-name"></div>
    <div class="ic-loc">
      <span class="ic-flag" id="ic-flag"></span>
      <span id="ic-loc"></span>
    </div>
    <div class="ic-sep"   id="ic-sep"></div>
    <div class="ic-role"  id="ic-role"></div>
    <div class="ic-gap"></div>
    <div class="ic-logic" id="ic-logic"></div>
    <div class="ic-badge" id="ic-badge"></div>
  </div>
</div>

<!-- TIMELINE -->
<div id="timeline">
  <div class="tl-track" id="tl-track">
    <div id="tl-fill"></div>
    <div id="tl-cursor"></div>
  </div>
  <div class="tl-labels" id="tl-labels"></div>
</div>
<div id="tl-badge"></div>

<!-- INTRO -->
<div id="intro">
  <div class="i-scan"></div>
  <div class="i-ring"></div>
  <div class="i-body">
    <div class="i-eye">1978 ‚Äî 2025</div>
    <div class="i-ttl">The Rise of the<br><span>GCC Mall</span></div>
    <div class="i-sub">Six Countries ¬∑ Five Phases ¬∑ 47 Years</div>
    <div class="i-ln"></div>
    <div class="i-st">
      <div class="i-s"><div class="i-sn">41</div><div class="i-sl">Major Malls</div></div>
      <div class="i-s"><div class="i-sn">6</div><div class="i-sl">Countries</div></div>
      <div class="i-s"><div class="i-sn">5</div><div class="i-sl">Phases</div></div>
      <div class="i-s"><div class="i-sn">47</div><div class="i-sl">Years</div></div>
    </div>
  </div>
</div>

<!-- OUTRO -->
<div id="outro">
  <div id="oc">
    <div class="o-eye">1978 ‚Äì 2025</div>
    <div class="o-ttl">The Rise of the<br><span>GCC Mall</span></div>
    <div class="o-credit">Prepared by Damien Nouvel 2026</div>
    <div class="o-sep"></div>
    <div class="o-stats">
      <div class="o-stat"><div class="o-sn">41+</div><div class="o-sl">Major Malls</div></div>
      <div class="o-stat"><div class="o-sn">6</div><div class="o-sl">Countries</div></div>
      <div class="o-stat"><div class="o-sn">5</div><div class="o-sl">Phases</div></div>
      <div class="o-stat"><div class="o-sn">47</div><div class="o-sl">Years</div></div>
    </div>
    <div class="o-phases" id="o-phases"></div>
    <button id="o-replay" onclick="startAnimation()">‚Ü∫ &nbsp; Replay</button>
  </div>
</div>

<script>
const BASE = "https://raw.githubusercontent.com/Dnouvel/GCC_MAlls/main/images/";

/* ‚îÄ‚îÄ PHASES ‚îÄ‚îÄ */
const PHASES = {
  1:{ num:"Phase 1", name:"Foundations",             html:"<em>Foundations</em>",               period:"1978 ‚Äì 1989", color:"#C0392B", q:"How do we modernize shopping?",  pills:["Enclosure","Air-conditioning","Commercial Zoning"] },
  2:{ num:"Phase 2", name:"Regionalization",          html:"<em>Regionalization</em>",            period:"1990 ‚Äì 1999", color:"#8E44AD", q:"How do we scale?",               pills:["Hypermarkets","Suburban Malls","Early Luxury"] },
  3:{ num:"Phase 3", name:"Mega & Experience",        html:"Mega &amp; <em>Experience</em>",      period:"2000 ‚Äì 2009", color:"#2471A3", q:"How do we compete globally?",    pills:["Ski Slopes","Aquariums","Mega Footprints","Tourism Retail"] },
  4:{ num:"Phase 4", name:"Lifestyle & Districts",    html:"Lifestyle &amp; <em>Districts</em>",  period:"2010 ‚Äì 2017", color:"#1E8449", q:"How do we retain consumers?",   pills:["Community Malls","Lifestyle Zoning","Mixed-Use"] },
  5:{ num:"Phase 5", name:"Reinvention & Post-Mega",  html:"<em>Reinvention</em> &amp; Post-Mega",period:"2018 ‚Äì 2025", color:"#D68910", q:"How do we reinvent?",           pills:["Entertainment Liberalization","Luxury Repositioning","Masterplan Integration"] },
};

/* ‚îÄ‚îÄ COUNTRY FALLBACKS (Unsplash) ‚îÄ‚îÄ */
const FB_EXT = {
  "UAE":          "https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800&q=80",
  "Saudi Arabia": "https://images.unsplash.com/photo-1578895101408-1a36b834405b?w=800&q=80",
  "Kuwait":       "https://images.unsplash.com/photo-1617575521317-d2974f3b56d2?w=800&q=80",
  "Qatar":        "https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=800&q=80",
  "Bahrain":      "https://images.unsplash.com/photo-1585664811087-47f65abbad64?w=800&q=80",
  "Oman":         "https://images.unsplash.com/photo-1586170761003-10ccea9b0ab6?w=800&q=80",
};
const FB_INT = {
  "UAE":          "https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=800&q=80",
  "Saudi Arabia": "https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800&q=80",
  "Kuwait":       "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=800&q=80",
  "Qatar":        "https://images.unsplash.com/photo-1519567770579-c2fc5e9ca4b5?w=800&q=80",
  "Bahrain":      "https://images.unsplash.com/photo-1472851294608-062f824d29cc?w=800&q=80",
  "Oman":         "https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&q=80",
};

/*
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  MALL DATA
  ext / int = filenames from your GitHub repo.
  null = file NOT in provided list ‚Üí will auto-fallback.

  IMAGE STATUS (v7):
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚úÖ All 42 malls have at least 1 real photo
  ‚ö†Ô∏è  Mall of Dhahran           ‚Äî only 1 image uploaded (interior uses country fallback)
  ‚ö†Ô∏è  City Centre Deira         ‚Äî interior filename has typo "City-Center-Diera 2.jpg" ‚Äî used as-is
  ‚ö†Ô∏è  Mall of the Emirates      ‚Äî 3 files provided; used [1] ext + [Dubai9052] int as best pair
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
*/
const MALLS = [
  // ‚îÄ‚îÄ PHASE 1 ‚îÄ‚îÄ
  { p:1, y:1978, n:"Salhia Complex",           c:"Kuwait",       ci:"Kuwait City", lat:29.369, lng:47.978,
    t:"Mixed-use retail",           r:"First modern retail complex in GCC",         l:"Transition from souqs to air-conditioned retail",
    ext:"Salhia Complex 1.jpg",     int:"Salhia Complex 2.jpg" },

  { p:1, y:1981, n:"Al Ghurair Centre",         c:"UAE",          ci:"Dubai",       lat:25.267, lng:55.319,
    t:"Enclosed mall",              r:"Early enclosed mall model",                  l:"Climate-controlled shopping adoption",
    ext:"al-ghurair-centre 1.jpg",  int:"al-ghurair-centre 2.jpg" },

  // ‚îÄ‚îÄ PHASE 2 ‚îÄ‚îÄ
  { p:2, y:1991, n:"BurJuman",                  c:"UAE",          ci:"Dubai",       lat:25.252, lng:55.304,
    t:"Luxury mall",                r:"Early luxury clustering",                    l:"Status-driven consumption",
    ext:"Burjuman 1.jpg",           int:"Burjuman 2.jpg" },

  { p:2, y:1991, n:"Wafi Mall",                 c:"UAE",          ci:"Dubai",       lat:25.231, lng:55.317,
    t:"Themed mall",                r:"Architecture-led destination",               l:"Experience via design",
    ext:"Wafi Mall 1.jpg",          int:"Wafi Mall 2.jpg" },

  { p:2, y:1992, n:"Al Maigliah Market Center",  c:"Saudi Arabia", ci:"Riyadh",      lat:24.688, lng:46.723,
    t:"Traditional market complex", r:"Formalized souq redevelopment",              l:"Modernizing traditional retail",
    ext:"al-maigliah 1.webp",       int:"al maigliah 2.jpg" },

  { p:2, y:1995, n:"City Centre Deira",          c:"UAE",          ci:"Dubai",       lat:25.251, lng:55.330,
    t:"Hypermarket mall",           r:"GCC regional mall template",                 l:"Anchor-led gravity model",
    ext:"city centre deira 1.jpg",  int:"City-Center-Diera 2.jpg" },  // ‚ö†Ô∏è interior filename has typo ‚Äî used as-is

  { p:2, y:1995, n:"Al Rashid Mall",             c:"Saudi Arabia", ci:"Khobar",      lat:26.283, lng:50.197,
    t:"Regional mall",              r:"Eastern Province retail anchor",             l:"Multi-city catchment gravity",
    ext:"al rashid Mall 1.jpg",     int:"al rashid mall 2.jpg" },

  { p:2, y:1997, n:"Seef Mall",                  c:"Bahrain",      ci:"Manama",      lat:26.214, lng:50.548,
    t:"Regional mall",              r:"Bahrain's modern mall take-off",             l:"Institutional retail platform",
    ext:"seef-mall 1.jpg",          int:"seef mall 2.jpg" },

  { p:2, y:1997, n:"Sahara Mall",                c:"Saudi Arabia", ci:"Riyadh",      lat:24.711, lng:46.674,
    t:"Regional mall",              r:"Early Riyadh modern mall",                   l:"Urban retail formalization",
    ext:"Sahara MAll Riyadh 1.jpg", int:"sahara mall Riyadh 2.jpeg" },

  { p:2, y:1999, n:"Granada Center",             c:"Saudi Arabia", ci:"Riyadh",      lat:24.710, lng:46.675,
    t:"Suburban mall",              r:"Riyadh suburban expansion",                  l:"Decentralization of retail",
    ext:"Granada Mall 1.webp",      int:"granada mall 2.jpg" },

  // ‚îÄ‚îÄ PHASE 3 ‚îÄ‚îÄ
  { p:3, y:2001, n:"Abu Dhabi Mall",             c:"UAE",          ci:"Abu Dhabi",   lat:24.494, lng:54.383,
    t:"City mall",                  r:"Capital retail consolidation",               l:"Retail maturity",
    ext:"abu dhabi mall 1.jpg",     int:"abu dhabi mall 2.jpg" },

  { p:3, y:2001, n:"City Centre Muscat",         c:"Oman",         ci:"Muscat",      lat:23.593, lng:58.110,
    t:"Regional mall",              r:"Oman's modern mall benchmark",               l:"Market formalization",
    ext:"city centre Muscat 1.avif",int:"city centre Muscat 2.avif" },

  { p:3, y:2001, n:"City Center Doha Mall",      c:"Qatar",        ci:"Doha",        lat:25.286, lng:51.533,
    t:"Regional mall",              r:"Qatar retail take-off",                      l:"Organized retail entry",
    ext:"city centre Doha 1.jpg",   int:"city centre doha 2.jpg" },

  { p:3, y:2002, n:"Kingdom Centre Mall",        c:"Saudi Arabia", ci:"Riyadh",      lat:24.711, lng:46.674,
    t:"Luxury podium",              r:"High-end corridor formation",                l:"Luxury segmentation",
    ext:"Kingdom Centre Mall 1.jpeg",int:"Kingdom Centre Mall 2.avif" },

  { p:3, y:2002, n:"Mercato Mall",               c:"UAE",          ci:"Dubai",       lat:25.207, lng:55.240,
    t:"Themed mall",                r:"European-style experience",                  l:"Design differentiation",
    ext:"Mercato Shopping Mall 1.jpg",int:"Mercato Shopping Mall 2.jpg" },

  { p:3, y:2004, n:"Souk Madinat Jumeirah",      c:"UAE",          ci:"Dubai",       lat:25.131, lng:55.185,
    t:"Themed heritage souk / resort retail", r:"Luxury heritage-themed waterfront destination", l:"Cultural theming and tourism integration",
    ext:"souk madinat Jumeirah.jpg", int:"Souk Madinat Jumeirah 2.avif" },

  { p:3, y:2005, n:"Mall of Dhahran",            c:"Saudi Arabia", ci:"Dhahran",     lat:26.310, lng:50.108,
    t:"Super-regional mall",        r:"Eastern Province super-regional scale",      l:"Regional consolidation",
    ext:"mall of dahran 1.jpg",     int:"dahran mall 2.webp" },                    

  { p:3, y:2005, n:"Mall of the Emirates",       c:"UAE",          ci:"Dubai",       lat:25.118, lng:55.200,
    t:"Destination mall",           r:"Ski Dubai anchor",                           l:"Retail + entertainment fusion",
    ext:"Mall of the Emirates 1.jpg",int:"Mall_of_the_Emirates-Dubai9052.jpg" },   // ‚ö†Ô∏è 3 files provided; used best pair

  { p:3, y:2005, n:"Ibn Battuta Mall",           c:"UAE",          ci:"Dubai",       lat:25.044, lng:55.114,
    t:"Themed mall",                r:"Narrative retail design",                    l:"Storytelling environments",
    ext:"Ibn Battuta 1.avif",       int:"Ibn battuta 2.jpg" },

  { p:3, y:2006, n:"Villaggio Mall",             c:"Qatar",        ci:"Doha",        lat:25.264, lng:51.447,
    t:"Experience mall",            r:"Themed leisure destination",                 l:"Tourism-oriented retail",
    ext:"Villagio Mall 1.jpg",      int:"Villaggio Mall 2.jpg" },

  { p:3, y:2007, n:"Dubai Festival City Mall",   c:"UAE",          ci:"Dubai",       lat:25.223, lng:55.352,
    t:"Waterfront district",        r:"Mixed-use lifestyle hub",                    l:"District retail model",
    ext:"Dubai Festival City Mall 1.avif",int:"Dubai Festival City Mall 2.jpg" },

  { p:3, y:2007, n:"The Avenues",                c:"Kuwait",       ci:"Kuwait City", lat:29.329, lng:47.934,
    t:"District mall",              r:'"City within a mall"',                       l:"Zoning-based retail",
    ext:"The Avenues Kuwait 1.jpg", int:"The Avenues Kuwait 2.jpg" },

  { p:3, y:2007, n:"Hayat Mall",                 c:"Saudi Arabia", ci:"Riyadh",      lat:24.827, lng:46.762,
    t:"Super-regional / lifestyle", r:"Major Riyadh family destination",            l:"Catchment-led lifestyle retail",
    ext:"Hayat Mall Riyadh 1.webp", int:"Hayat Mall Riyadh 2.jpg" },

  { p:3, y:2007, n:"Alandalus Mall",             c:"Saudi Arabia", ci:"Jeddah",      lat:21.543, lng:39.172,
    t:"Super-regional mall",        r:"Central Jeddah retail hub",                  l:"Corridor-based consolidation",
    ext:"Alandalus mall 1.jpg",     int:"Alandalus mall 2.jpg" },

  { p:3, y:2008, n:"The Dubai Mall",             c:"UAE",          ci:"Dubai",       lat:25.197, lng:55.279,
    t:"Mega mall",                  r:"Global retail landmark",                     l:"Retail as branding infrastructure",
    ext:"Dubai Mall 1.jpg",         int:"dubai mall 2.jpg" },

  { p:3, y:2008, n:"Red Sea Mall",               c:"Saudi Arabia", ci:"Jeddah",      lat:21.578, lng:39.195,
    t:"Super-regional mall",        r:"Jeddah retail step-change",                  l:"Western Saudi consolidation",
    ext:"Red-Sea-Mall-1.jpg",       int:"red sea mall 2.jpg" },

  { p:3, y:2008, n:"Mall of Arabia",             c:"Saudi Arabia", ci:"Jeddah",      lat:21.607, lng:39.138,
    t:"Destination mall",           r:"Northern Jeddah flagship",                   l:"Highway-corridor expansion",
    ext:"Mall of Arabia 1.webp",    int:"mall of arabia 2.jpg" },

  { p:3, y:2008, n:"City Centre Bahrain",        c:"Bahrain",      ci:"Manama",      lat:26.216, lng:50.547,
    t:"Super-regional mall",        r:"Family leisure anchor",                      l:"Leisure-based retention",
    ext:"Bahrain_City_Centre.jpg",  int:"Bahrain_City_Centre 2.jpg" },

  { p:3, y:2009, n:"360 Mall",                   c:"Kuwait",       ci:"Kuwait City", lat:29.279, lng:47.998,
    t:"Premium lifestyle mall",     r:"Design-led positioning",                     l:"High-end lifestyle clustering",
    ext:"360 Mall Kuwait 1.jpg",    int:"360 Mall Kuwait 2.jpg" },

  // ‚îÄ‚îÄ PHASE 4 ‚îÄ‚îÄ
  { p:4, y:2011, n:"Al Nakheel Mall",            c:"Saudi Arabia", ci:"Riyadh",      lat:24.775, lng:46.638,
    t:"Community mall",             r:"North Riyadh hub",                           l:"Corridor densification",
    ext:"AL Nakheel Mall Riyadh 1.jpg", int:"al nakheel nall riyadh 2.jpg" },

  { p:4, y:2013, n:"The Galleria Al Maryah",     c:"UAE",          ci:"Abu Dhabi",   lat:24.497, lng:54.386,
    t:"Luxury waterfront",          r:"CBD luxury retail platform",                 l:"Finance + luxury synergy",
    ext:"The Galleria Al Maryah Island 1.avif",int:"The Galleria Al Maryah Island 2.jpg" },

  { p:4, y:2014, n:"Yas Mall",                   c:"UAE",          ci:"Abu Dhabi",   lat:24.489, lng:54.609,
    t:"Leisure-integrated mall",    r:"Theme-park adjacency",                       l:"Ecosystem retail",
    ext:"Yas Mall 1.jpg",           int:"Yas Mall 2.jpg" },

  { p:4, y:2015, n:"Gulf Mall",                  c:"Qatar",        ci:"Doha",        lat:25.331, lng:51.488,
    t:"Regional mall",              r:"GCC identity branding",                      l:"Identity positioning",
    ext:"Gulf Mall Qatar 1.jpg",    int:"Gulf Mall Qatar 2.webp" },

  { p:4, y:2015, n:"Oman Avenues Mall",          c:"Oman",         ci:"Muscat",      lat:23.614, lng:58.593,
    t:"Super-regional mall",        r:"Supply expansion",                           l:"Market deepening",
    ext:"Oman Avenues Mall 1.jpeg", int:"Oman Avenues Mall 2.jpeg" },

  { p:4, y:2016, n:"Mall of Qatar",              c:"Qatar",        ci:"Al Rayyan",   lat:25.320, lng:51.439,
    t:"Flagship mall",              r:"Entertainment-led model",                    l:"Programming-driven footfall",
    ext:"Mall of Qatar 1.jpg",      int:"Mall of Qatar 2.jpg" },

  // ‚îÄ‚îÄ PHASE 5 ‚îÄ‚îÄ
  { p:5, y:2018, n:"Al Kout Mall",               c:"Kuwait",       ci:"Fahaheel",    lat:29.079, lng:48.130,
    t:"Waterfront mall",            r:"Leisure + waterfront retail",                l:"Place-making + F&B gravity",
    ext:"al kout mall 1.webp",      int:"al kout mall 2.jpg" },

  { p:5, y:2019, n:"Palm Jumeirah Mall",          c:"UAE",          ci:"Dubai",       lat:25.112, lng:55.139,
    t:"Island mall",                r:"Tourism + community hybrid",                 l:"Mixed demand capture",
    ext:"Palm Jumeirah Mall.jpg",   int:"palm jumeirah 2.jpg" },

  { p:5, y:2019, n:"Cityland Mall",              c:"UAE",          ci:"Dubai",       lat:25.072, lng:55.310,
    t:"Green concept mall",         r:"Nature-themed branding",                     l:"Lifestyle differentiation",
    ext:"Cityland Mall 1.jpg",      int:"Cityland Mall 2.jpg" },

  { p:5, y:2022, n:"Dubai Hills Mall",           c:"UAE",          ci:"Dubai",       lat:25.108, lng:55.231,
    t:"Community flagship",         r:"Masterplan retail",                          l:"Residential integration",
    ext:"Dubai Hills Mall 1.avif",  int:"Dubai Hills Mall 2.jpg" },

  { p:5, y:2023, n:"Reem Mall",                  c:"UAE",          ci:"Abu Dhabi",   lat:24.509, lng:54.408,
    t:"Snow-anchored mall",         r:"Experience escalation",                      l:"Differentiation in mature market",
    ext:"Reem Mall 1.jpg",          int:"Reem Mall 2.jpg" },

  { p:5, y:2025, n:"Solitaire Mall",             c:"Saudi Arabia", ci:"Riyadh",      lat:24.758, lng:46.691,
    t:"Luxury destination",         r:"Premium repositioning",                      l:"Specialization over scale",
    ext:"Solitaire Mall 1.jpg",     int:"Solitaire Mall 2.webp" },
];

/* ‚îÄ‚îÄ COUNTRY COLORS & FLAGS ‚îÄ‚îÄ */
const CC = {"UAE":"#2ECC71","Saudi Arabia":"#E74C3C","Kuwait":"#3498DB","Qatar":"#E67E22","Bahrain":"#9B59B6","Oman":"#1ABC9C"};
const CF = {"UAE":"üá¶üá™","Saudi Arabia":"üá∏üá¶","Kuwait":"üá∞üáº","Qatar":"üá∂üá¶","Bahrain":"üáßüá≠","Oman":"üá¥üá≤"};

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
const map = L.map('map',{
  center:[24.5,50],zoom:5,
  zoomControl:false,attributionControl:false,
  dragging:false,scrollWheelZoom:false,doubleClickZoom:false,touchZoom:false,
});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);

/* ‚îÄ‚îÄ TIMELINE BUILD ‚îÄ‚îÄ */
const Y0=1978, Y1=2025, YS=Y1-Y0;
const pct = y => ((y-Y0)/YS*100).toFixed(3)+'%';

(function buildTL(){
  const track=document.getElementById('tl-track');
  const labels=document.getElementById('tl-labels');
  const oP=document.getElementById('o-phases');
  const segs=[{ph:1,s:1978,e:1990},{ph:2,s:1990,e:2000},{ph:3,s:2000,e:2010},{ph:4,s:2010,e:2018},{ph:5,s:2018,e:2026}];
  segs.forEach(sg=>{
    const l=((sg.s-Y0)/YS*100), w=((sg.e-sg.s)/YS*100);
    const seg=document.createElement('div');
    seg.className='tl-seg'; seg.dataset.ph=sg.ph;
    seg.style.cssText=`left:${l}%;width:${w}%;background:${PHASES[sg.ph].color}`;
    track.appendChild(seg);
    const ll=document.createElement('div');
    ll.className='tl-lbl'; ll.dataset.ph=sg.ph;
    ll.style.cssText=`flex:0 0 ${w}%;color:${PHASES[sg.ph].color}`;
    ll.textContent=PHASES[sg.ph].name; labels.appendChild(ll);
    const op=document.createElement('div');
    op.className='o-pill'; op.textContent=PHASES[sg.ph].name;
    const c=PHASES[sg.ph].color;
    op.style.cssText=`background:${c}22;color:${c};border:1px solid ${c}44`;
    oP.appendChild(op);
  });
  MALLS.forEach(m=>{
    const d=document.createElement('div');
    d.className='tl-dot'; d.dataset.y=m.y; d.style.left=pct(m.y); track.appendChild(d);
  });
})();

/* ‚îÄ‚îÄ IMAGE LOADER ‚îÄ‚îÄ */
function loadImg(imgEl, phEl, filename, fallbackUrl) {
  imgEl.src=''; imgEl.classList.remove('loaded'); phEl.classList.remove('hidden');
  if (!filename) { return; } // stay on placeholder

  const primaryUrl = BASE + encodeURIComponent(filename);

  const tryLoad = (url) => {
    const t = new Image();
    t.crossOrigin = 'anonymous';
    t.onload = () => {
      imgEl.src = url;
      imgEl.classList.add('loaded');
      phEl.classList.add('hidden');
    };
    t.onerror = () => {
      if (url !== fallbackUrl) tryLoad(fallbackUrl);
    };
    t.src = url;
  };
  tryLoad(primaryUrl);
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
let markers=[], running=false, _t=null;
const sleep = ms => new Promise(r=>{ _t=setTimeout(r,ms); });
const pin   = c  => L.divIcon({className:'',html:`<div class="mall-pin" style="background:${c};box-shadow:0 0 14px ${c}99"></div>`,iconSize:[14,14],iconAnchor:[7,7]});

function setPh(col){ document.documentElement.style.setProperty('--ph',col); }

function updateBanner(ph){
  const p=PHASES[ph]; setPh(p.color);
  document.getElementById('pb-num').textContent=p.num;
  document.getElementById('pb-name').innerHTML=p.html;
  document.getElementById('pb-period').textContent=p.period;
  document.getElementById('pb-q').textContent=p.q;
  const pc=document.getElementById('pb-pills'); pc.innerHTML='';
  p.pills.forEach(txt=>{
    const el=document.createElement('div'); el.className='pb-pill'; el.textContent=txt;
    el.style.cssText=`background:${p.color}1a;color:${p.color};border:1px solid ${p.color}44`;
    pc.appendChild(el);
  });
}

function updateTL(year,ph){
  const p=pct(year);
  document.getElementById('tl-fill').style.width=p;
  document.getElementById('tl-cursor').style.left=p;
  const b=document.getElementById('tl-badge');
  b.textContent=year; b.style.left=p; b.classList.add('show');
  document.querySelectorAll('.tl-dot').forEach(d=>d.classList.toggle('lit',parseInt(d.dataset.y)<=year));
  document.querySelectorAll('.tl-lbl').forEach(l=>l.classList.toggle('active',parseInt(l.dataset.ph)===ph));
}

function showCards(m){
  const cc=CC[m.c], pc=PHASES[m.p].color;
  // photo card
  document.getElementById('ph-bar').style.background=pc;
  document.getElementById('ph-name').textContent=m.n;
  document.getElementById('ph-city').textContent=`${m.ci} ¬∑ ${m.c}`;
  loadImg(document.getElementById('ph-ext-img'), document.getElementById('ph-ext-ph'), m.ext, FB_EXT[m.c]);
  loadImg(document.getElementById('ph-int-img'), document.getElementById('ph-int-ph'), m.int, FB_INT[m.c]);
  document.getElementById('photo-card').classList.add('show');
  // info card
  document.getElementById('ic-bar').style.background=pc;
  document.getElementById('ic-sep').style.cssText=`height:1px;margin:16px 0;opacity:0.25;background:linear-gradient(90deg,${pc},transparent)`;
  document.getElementById('ic-year').textContent=m.y;
  document.getElementById('ic-type').textContent=m.t;
  document.getElementById('ic-name').textContent=m.n;
  document.getElementById('ic-flag').textContent=CF[m.c];
  document.getElementById('ic-loc').textContent=`${m.ci}, ${m.c}`;
  document.getElementById('ic-role').textContent=m.r;
  document.getElementById('ic-logic').textContent=m.l;
  const badge=document.getElementById('ic-badge');
  badge.textContent=m.c;
  badge.style.cssText=`background:${cc}1a;color:${cc};border:1px solid ${cc}44`;
  document.getElementById('info-card').classList.add('show');
}

function hideCards(){
  document.getElementById('photo-card').classList.remove('show');
  document.getElementById('info-card').classList.remove('show');
}

function clearAll(){
  clearTimeout(_t); markers.forEach(m=>map.removeLayer(m)); markers=[];
  hideCards();
  document.getElementById('outro').classList.remove('show');
  document.getElementById('timeline').classList.remove('show');
  document.getElementById('tl-badge').classList.remove('show');
  document.getElementById('tl-fill').style.width='0%';
  document.getElementById('tl-cursor').style.left='0%';
  document.querySelectorAll('.tl-dot').forEach(d=>d.classList.remove('lit'));
  document.querySelectorAll('.tl-lbl').forEach(l=>l.classList.remove('active'));
  document.getElementById('pb-n').textContent='0';
}

/* ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ */
async function startAnimation(){
  if(running) return; running=true;
  clearAll();
  document.getElementById('intro').classList.remove('gone');
  updateBanner(1);
  await sleep(4400);
  document.getElementById('intro').classList.add('gone');
  await sleep(1200);
  map.setView([24.5,50],5,{animate:false});
  document.getElementById('timeline').classList.add('show');
  let count=0, lastPh=null;
  for(let i=0;i<MALLS.length;i++){
    const m=MALLS[i];
    if(m.p!==lastPh){ lastPh=m.p; hideCards(); await sleep(150); updateBanner(m.p); await sleep(700); }
    map.flyTo([m.lat,m.lng],7,{duration:1.0,easeLinearity:0.5});
    await sleep(900);
    const mk=L.marker([m.lat,m.lng],{icon:pin(CC[m.c])}).addTo(map);
    markers.push(mk);
    count++;
    document.getElementById('pb-n').textContent=count;
    updateTL(m.y,m.p);
    showCards(m);
    await sleep(3400);
    hideCards(); await sleep(280);
  }
  hideCards(); await sleep(400);
  map.flyTo([24.5,50],5,{duration:2.2});
  await sleep(2400);
  document.getElementById('outro').classList.add('show');
  running=false;
}

window.addEventListener('load',()=>setTimeout(startAnimation,600));
</script>
</body>
</html>
